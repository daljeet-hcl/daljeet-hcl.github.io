<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="theme-color" content="#000000">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

  <!-- Latest compiled JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <!--material design libraries-->

  <script src="https://unpkg.com/popper.js@1.12.6/dist/umd/popper.js" integrity="sha384-fA23ZRQ3G/J53mElWqVJEGJzU0sTs+SvzG8fXVWP+kJQ1lwFAOkcUOysnlKJC33U"
    crossorigin="anonymous"></script>
  <script src="https://unpkg.com/bootstrap-material-design@4.1.1/dist/js/bootstrap-material-design.js" integrity="sha384-CauSuKpEqAFajSpkdjv3z9t8E7RlpJ1UP0lKM/+NdtSarroVKu069AlsRPKkFBz9"
    crossorigin="anonymous"></script>
  <script>$(document).ready(function () { $('body').bootstrapMaterialDesign(); });</script>

</head>
<style>
  input#page {
    width: 25%
  }
</style>

<body>

  <h4>Guru Granth Sahib</h4>



  <div class="form-group" id="content">
    <form action="index.html">
      <label for="page">Pageno:</label>
      <input type="number" class="form-control" id="page" name="page">
      <br>
      <button type="submit" class="btn">Load Page</button>
      <button type="button" class="btn" id="copy"> WhatsApp Share </button>
    </form>
    <form id="demo"></form>
  </div>

  <script>
    var responseData; //this would be array
    var info; //contain data about pageno, Source , Author etc 

    $(window).on("load", function () {
      var page = getURLParameter("page");
      if (page != null) {
        $("#page").val(page);
        loadXMLDoc(page);
      } else {
        var shabadID = getURLParameter("shabad");
        if (shabadID != null) {
          loadShabad(shabadID);
        }
      }
    })

    function getURLParameter(sParam) {
      var sPageURL = window.location.search.substring(1);
      var sURLVariables = sPageURL.split('&');
      for (var i = 0; i < sURLVariables.length; i++) {
        var sParameterName = sURLVariables[i].split('=');
        if (sParameterName[0] == sParam) {
          return sParameterName[1];
        }
      }
    }

    $("#copy").click(function () {
      var url = "whatsapp://send?text=" + getData();
      window.open(url);
    });

    function getData() {
      var data = '';
      $('input:checkbox').filter(':checked').map(function () {
        var lineNo = $(this).val();
        console.log("lineNo" + lineNo);
        console.log(responseData[lineNo].line.transliteration.devanagari.text);
        console.log(responseData[lineNo].line.translation.english.default);
        data += '\n\r*' + responseData[lineNo].line.transliteration.devanagari.text + '*\n\r';
        data += responseData[lineNo].line.translation.english.default + '\n';
      });
      return encodeURI(data);
    }

    function loadXMLDoc(pageNo) {
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          var response = JSON.parse(this.responseText);
          responseData = response.page;
          console.log(response.pageno);
          var previous = pageNo - 1
          var next = parseInt(pageNo) + 1;
          var header = "<p/><a href='?page=" + previous + "' class='btn btn-default btn-sm'> <span class='glyphicon glyphicon-circle-arrow-left'> </span>  </a>  Page No = " + response.pageno + "  <a href='?page=" + next + "' class='btn btn-default btn-sm'> <span class='glyphicon glyphicon-circle-arrow-right'></span> </a><br/>"
          
          $("#demo").html(header); //add header
          response.page.map((line, index) => {
            displayLine(line, index)
          });
          $("#demo").html($("#demo").html() + header); //add footer
        }
      };
      xhttp.open("GET", "https://api.gurbaninow.com/v2/ang/" + pageNo, true);
      xhttp.send();
    }

    function loadShabad(shabadID) {
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          var response = JSON.parse(this.responseText);
          responseData = response.shabad;
          console.log(response.shabadinfo.shabadid);

          var previous = shabadID - 1
          var next = parseInt(shabadID) + 1;
          var header = "<p/><a href='?shabad=" + previous + "' class='btn btn-default btn-sm'> <span class='glyphicon glyphicon-circle-arrow-left'> </span>  </a>   Shabad No = " + response.shabadinfo.shabadid  + "  <a href='?shabad=" + next + "' class='btn btn-default btn-sm'> <span class='glyphicon glyphicon-circle-arrow-right'></span> </a><br/>"
          
          $("#demo").html(header); //add header
          response.shabad.map((line, index) => {
            displayLine(line, index)
          });
          $("#demo").html($("#demo").html() + header); //add footer
        }
      };
      xhttp.open("GET", "https://api.gurbaninow.com/v2/shabad/" + shabadID, true);
      xhttp.send();
    }

    function displayLine(line, index) {
      $("#demo").html($("#demo").html() + "<br/> <input type='checkbox' value=" + index + " /><b>" + line.line.transliteration.devanagari.text + '</b>');
      $("#demo").html($("#demo").html() + "<br/>" + line.line.translation.english.default + "<br/>");
    }

  </script>

</body>

</html>